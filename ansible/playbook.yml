---
- hosts: all
  become: root
  gather_facts: no
  tasks:
      - name: Install aptitude
        apt:
          name: aptitude
          state: latest
          update_cache: true

      - name: Install required system packages
        apt:
          pkg:
            - apt-transport-https
            - ca-certificates
            - curl
            - software-properties-common
            - python3-pip
            - virtualenv
            - python3-setuptools
          state: latest
          update_cache: true

      - name: Add Docker GPG apt Key
        apt_key:
          url: https://download.docker.com/linux/ubuntu/gpg
          state: present

      - name: Add Docker Repository
        apt_repository:
          repo: deb https://download.docker.com/linux/ubuntu bionic stable
          state: present

      - name: Update apt and install docker-ce
        apt:
          name: docker-ce
          state: latest
          update_cache: true

      - name: Update apt and install ansible
        apt:
          name: ansible
          state: latest
          update_cache: true

      - name: Install Docker Module for Python
        pip:
          name: docker

      - name: create build directory
        file:
          path: /root/demo-dockerfile
          state: directory
          owner: root
          group: root
          mode: '0755'
      - name: copy Dockerfile
        copy:
          src: ./Dockerfile
          dest: /root/demo-dockerfile/Dockerfile
          owner: root
          group: root
          mode: '0644'
      - name: build container image
        docker_image:
          name: hello_devops_container:latest
          build:
            path: /root/demo-dockerfile
            source: build
          state: present

      - name: archive container image as a tarball
        docker_image:
          name: democontainer:v1.0
          archive_path: /root/hello_devops_container.tar
          source: pull
          state: present
      - name: fetch archived image
        fetch:
          src: /root/hello_devops_container.tar
          dest: ./hello_devops_container.tar
          flat: true

      - name: copy tarball to host
        copy:
          src: ./hello_devops_container.tar
          dest: /root/hello_devops_container.tar

      - name: load container from tarball
        docker_image:
          name: democontainer:v1.0
          load_path: /root/hello_devops_container.tar
          state: present
          source: load